{% extends "base.html" %}

{% block title %}User Profile - Secret Journal Manager{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-user me-2"></i>My Profile</h2>
            {% if current_user.is_admin %}
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-tachometer-alt me-1"></i>Admin Dashboard
            </a>
            {% endif %}
        </div>
        
        <!-- Account Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-info-circle me-2"></i>Account Information</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Username</label>
                        <div class="form-control-plaintext">{{ current_user.username }}</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Email Address</label>
                        <div class="form-control-plaintext">
                            {{ current_user.email }}
                            {% if current_user.email_verified %}
                            <span class="badge bg-success ms-2">Verified</span>
                            {% else %}
                            <span class="badge bg-warning text-dark ms-2">Unverified</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Account Type</label>
                        <div class="form-control-plaintext">
                            {% if current_user.is_admin %}
                            <span class="badge bg-primary">Administrator</span>
                            {% else %}
                            <span class="badge bg-secondary">Standard User</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Account Status</label>
                        <div class="form-control-plaintext">
                            {% if current_user.is_active %}
                            <span class="badge bg-success">Active</span>
                            {% else %}
                            <span class="badge bg-danger">Disabled</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Member Since</label>
                        <div class="form-control-plaintext">{{ current_user.created_at.strftime('%B %d, %Y') if current_user.created_at else 'N/A' }}</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Last Login</label>
                        <div class="form-control-plaintext">
                            {% if current_user.last_login %}
                            {{ current_user.last_login.strftime('%B %d, %Y at %I:%M %p') }}
                            {% else %}
                            <span class="text-muted">Never</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Security Status -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-shield-alt me-2"></i>Security Status</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="security-check">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Password Protection</span>
                                <span class="badge bg-success">
                                    <i class="fas fa-check"></i> Active
                                </span>
                            </div>
                            <small class="text-muted">Last changed: {{ current_user.password_changed_at.strftime('%Y-%m-%d') if current_user.password_changed_at else 'N/A' }}</small>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="security-check">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Security Questions</span>
                                {% if current_user.security_questions %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check"></i> Configured
                                </span>
                                {% else %}
                                <span class="badge bg-warning text-dark">
                                    <i class="fas fa-exclamation-triangle"></i> Missing
                                </span>
                                {% endif %}
                            </div>
                            <small class="text-muted">3 personalized questions</small>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="security-check">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Recovery Phrase</span>
                                {% if current_user.recovery_phrase %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check"></i> Generated
                                </span>
                                {% else %}
                                <span class="badge bg-warning text-dark">
                                    <i class="fas fa-exclamation-triangle"></i> Missing
                                </span>
                                {% endif %}
                            </div>
                            <small class="text-muted">12-word backup phrase</small>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="security-check">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Encryption Keys</span>
                                {% if user_keys %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check"></i> 5-Key System
                                </span>
                                {% else %}
                                <span class="badge bg-danger">
                                    <i class="fas fa-times"></i> Not Setup
                                </span>
                                {% endif %}
                            </div>
                            <small class="text-muted">Version: {{ user_keys.key_version if user_keys else 'N/A' }}</small>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>Your Data is Protected</h6>
                        <p class="mb-0">Your secrets are protected by our 5-key encryption system. Even if you forget your password, your data can be recovered using security questions, recovery phrase, admin assistance, or emergency procedures.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Encryption Key Management -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-key me-2"></i>Encryption Key Management</h5>
            </div>
            <div class="card-body">
                {% if user_keys %}
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="stat-box">
                            <h6 class="text-primary">Key Version</h6>
                            <span class="badge bg-primary">Version {{ user_keys.key_version }}</span>
                            <small class="text-muted d-block">Created: {{ user_keys.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="stat-box">
                            <h6 class="text-success">Key Status</h6>
                            <span class="badge bg-success">Active & Secure</span>
                            <small class="text-muted d-block">5-Key System Enabled</small>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <div class="row g-2">
                    <div class="col-md-6">
                        <button class="btn btn-outline-warning w-100" onclick="rotateKeys()">
                            <i class="fas fa-sync-alt me-2"></i>Rotate Encryption Keys
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-outline-info w-100" data-bs-toggle="modal" data-bs-target="#keyInfoModal">
                            <i class="fas fa-info-circle me-2"></i>Key Information
                        </button>
                    </div>
                </div>
                
                <div class="alert alert-warning mt-3">
                    <small><strong>Note:</strong> Key rotation will re-encrypt all your secrets with new keys. This process is irreversible but ensures maximum security.</small>
                </div>
                {% else %}
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Encryption Keys Not Configured</h6>
                    <p class="mb-3">Your account doesn't have encryption keys set up. You need to initialize your keys to store secrets securely.</p>
                    <button class="btn btn-primary" onclick="initializeKeys()">
                        <i class="fas fa-key me-2"></i>Initialize Encryption Keys
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Statistics -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar me-2"></i>Usage Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-4">
                        <div class="stat-box">
                            <h3 class="text-primary">{{ current_user.secrets|length }}</h3>
                            <small class="text-muted">Stored Secrets</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-box">
                            <h3 class="text-success">{{ journal_count or 0 }}</h3>
                            <small class="text-muted">Journal Entries</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-box">
                            <h3 class="text-info">{{ shared_count or 0 }}</h3>
                            <small class="text-muted">Shared Secrets</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-tools me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <a href="{{ url_for('secrets') }}" class="btn btn-outline-primary w-100">
                            <i class="fas fa-key me-2"></i>Manage Secrets
                        </a>
                    </div>
                    <div class="col-md-6">
                        <a href="{{ url_for('journal') }}" class="btn btn-outline-success w-100">
                            <i class="fas fa-calendar-alt me-2"></i>Write Journal
                        </a>
                    </div>
                    <div class="col-md-6">
                        <a href="{{ url_for('change_password') }}" class="btn btn-outline-warning w-100">
                            <i class="fas fa-lock me-2"></i>Change Password
                        </a>
                    </div>
                    <div class="col-md-6">
                        <a href="{{ url_for('update_recovery') }}" class="btn btn-outline-info w-100">
                            <i class="fas fa-cog me-2"></i>Update Recovery Options
                        </a>
                    </div>
                    <div class="col-md-6">
                        <a href="{{ url_for('key_rotation') }}" class="btn btn-outline-danger w-100">
                            <i class="fas fa-sync-alt me-2"></i>Rotate All Keys
                        </a>
                    </div>
                    <div class="col-md-6">
                        <a href="{{ url_for('export_data') }}" class="btn btn-outline-secondary w-100" id="exportBtn" 
                           data-bs-toggle="tooltip" data-bs-placement="top" 
                           title="Download a JSON backup of all your data including secrets (encrypted), journal entries, and profile information">
                            <i class="fas fa-download me-2"></i>Export Data
                        </a>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-outline-secondary w-100" disabled>
                            <i class="fas fa-share-alt me-2"></i>Share Settings
                        </button>
                    </div>
                </div>
                
                <hr>
                
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>Data Export Information</h6>
                    <p class="mb-2">Your data export includes:</p>
                    <ul class="mb-2">
                        <li><strong>Profile information:</strong> Username, email, account settings</li>
                        <li><strong>Encrypted secrets:</strong> All your secrets in encrypted form for security</li>
                        <li><strong>Journal entries:</strong> All your journal entries in plain text</li>
                        <li><strong>Security setup:</strong> Information about your recovery options</li>
                    </ul>
                    <small><strong>Note:</strong> Secrets remain encrypted in the export for security. This export can be used for backup purposes or data portability.</small>
                </div>
                
                <div class="text-center">
                    <p class="text-muted mb-2"><small>Need help with account recovery?</small></p>
                    <a href="{{ url_for('setup_recovery') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-question-circle me-1"></i>Recovery Options
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Key Information Modal -->
<div class="modal fade" id="keyInfoModal" tabindex="-1" aria-labelledby="keyInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="keyInfoModalLabel">
                    <i class="fas fa-info-circle me-2"></i>Encryption Key Information
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6>5-Key Encryption System</h6>
                <p>Your data is protected using a sophisticated 5-key encryption system:</p>
                <ul>
                    <li><strong>Password-based Key:</strong> Derived from your account password</li>
                    <li><strong>Security Questions Key:</strong> Based on your security question answers</li>
                    <li><strong>Recovery Phrase Key:</strong> Generated from your recovery phrase</li>
                    <li><strong>Admin Recovery Key:</strong> For administrative recovery procedures</li>
                    <li><strong>Emergency Key:</strong> For emergency access situations</li>
                </ul>
                
                <h6 class="mt-3">Key Rotation</h6>
                <p>Key rotation generates new encryption keys while preserving your data:</p>
                <ul>
                    <li>All secrets are decrypted with current keys</li>
                    <li>New keys are generated using updated information</li>
                    <li>All data is re-encrypted with new keys</li>
                    <li>Old keys are securely destroyed</li>
                    <li><strong>Admin access is preserved:</strong> New A-DEK created with current admin master key</li>
                </ul>
                
                <div class="alert alert-success">
                    <small><strong>Admin Recovery:</strong> Key rotation maintains admin recovery capabilities. Your data remains accessible through admin assistance even after rotation.</small>
                </div>
                
                <div class="alert alert-info">
                    <small><strong>Security Note:</strong> Regular key rotation enhances security by limiting the exposure window of any single key set.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
.security-check {
    padding: 0.75rem;
    border: 1px solid var(--bs-border-color);
    border-radius: 0.375rem;
    background-color: var(--bs-light);
}

.stat-box {
    padding: 1rem;
}

.stat-box h3 {
    margin-bottom: 0.25rem;
}
</style>

<script>
function initializeKeys() {
    if (confirm('This will create your encryption keys and enable secure storage. Continue?')) {
        fetch('/api/initialize_keys', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Encryption keys initialized successfully!', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert('Failed to initialize keys: ' + (data.error || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Network error occurred', 'danger');
        });
    }
}

function rotateKeys() {
    if (confirm('This will rotate all your encryption keys and re-encrypt your data. This process cannot be undone. Continue?')) {
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Rotating Keys...';
        button.disabled = true;
        
        fetch('/api/rotate_keys', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Encryption keys rotated successfully!', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert('Failed to rotate keys: ' + (data.error || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Network error occurred', 'danger');
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Handle export data with loading state
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', function(e) {
            // Show loading state
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Exporting...';
            this.classList.add('disabled');
            
            // Show info message
            showAlert('Preparing your data export...', 'info');
            
            // Reset button after download starts (the browser will handle the download)
            setTimeout(() => {
                this.innerHTML = originalText;
                this.classList.remove('disabled');
                showAlert('Export started! Check your downloads folder.', 'success');
            }, 2000);
        });
    }
});
</script>
{% endblock %}
