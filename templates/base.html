<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Secret Journal Manager{% endblock %}</title>
    
    <!-- Bootstrap CSS with Replit theme -->
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- FullCalendar CSS -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css' rel='stylesheet' />
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    {% block head %}{% endblock %}
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-shield-alt me-2"></i>Secret Journal
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('journal') }}">
                            <i class="fas fa-calendar-alt me-1"></i>Journal
                        </a>
                    </li>
                    {% if current_user.is_authenticated %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('secrets') }}">
                            <i class="fas fa-key me-1"></i>Secrets
                        </a>
                    </li>
                    {% endif %}
                    {% if current_user.is_authenticated and current_user.is_admin %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-cog me-1"></i>Admin
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('admin_dashboard') }}">Dashboard</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('admin_users') }}">Users</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('admin_key_rotation_management') }}">
                                <i class="fas fa-sync-alt me-1"></i>Key Rotation
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('admin_audit') }}">Audit Logs</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('admin_export_all_data') }}">
                                <i class="fas fa-database me-1"></i>System Backup
                            </a></li>
                        </ul>
                    </li>
                    {% endif %}
                </ul>
                
                <ul class="navbar-nav">
                    {% if current_user.is_authenticated %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i>{{ current_user.username }}
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('user_profile') }}">Profile</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('key_rotation') }}">
                                <i class="fas fa-sync-alt me-1"></i>Key Rotation
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('export_data') }}">
                                <i class="fas fa-download me-1"></i>Export Data
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('logout') }}">Logout</a></li>
                        </ul>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('login') }}">
                            <i class="fas fa-sign-in-alt me-1"></i>Login
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('register') }}">
                            <i class="fas fa-user-plus me-1"></i>Register
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Flash Messages -->
    <div class="container mt-3">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'primary' if category == 'info' else category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <!-- Main Content -->
    <main class="container my-4">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container text-center">
            <p>&copy; 2025 Secret Journal Manager - Your data, always recoverable.</p>
            <p class="small">Protected by 5-key encryption system</p>
        </div>
    </footer>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- FullCalendar JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='app.js') }}"></script>
    
    <!-- Auto-logout on browser tab close -->
    {% if current_user.is_authenticated %}
    <script>
    // Auto-logout functionality for tab close detection
    let logoutSent = false;
    let isNavigating = false;
    let isFormSubmitting = false;
    let isRefreshing = false;
    
    // Track internal navigation to avoid false tab close detection
    document.addEventListener('submit', function() {
        isFormSubmitting = true;
        setTimeout(() => { isFormSubmitting = false; }, 1000);
    });
    
    document.addEventListener('click', function(e) {
        const target = e.target.closest('a');
        if (target && target.href) {
            // Check if it's internal navigation
            if (target.href.startsWith(window.location.origin) || target.href.startsWith('/')) {
                isNavigating = true;
                setTimeout(() => { isNavigating = false; }, 500);
            }
        }
    });
    
    // Detect page refresh (F5, Ctrl+R)
    document.addEventListener('keydown', function(e) {
        if ((e.key === 'F5') || (e.ctrlKey && e.key === 'r')) {
            isRefreshing = true;
        }
    });
    
    // Send logout request specifically for tab close
    function sendTabCloseLogout() {
        if (logoutSent || isNavigating || isFormSubmitting || isRefreshing) {
            return;
        }
        
        logoutSent = true;
        console.log('Tab close detected - sending logout request');
        
        // Use sendBeacon for reliable delivery during tab close
        if (navigator.sendBeacon) {
            const formData = new FormData();
            formData.append('logout_type', 'tab_close');
            navigator.sendBeacon('{{ url_for("browser_close_logout") }}', formData);
        } else {
            // Fallback for older browsers
            try {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', '{{ url_for("browser_close_logout") }}', false);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.send(JSON.stringify({logout_type: 'tab_close'}));
            } catch (e) {
                console.log('Failed to send tab close logout:', e);
            }
        }
    }
    
    // Primary tab close detection - more reliable than beforeunload
    window.addEventListener('pagehide', function(e) {
        // Only trigger if the page is being permanently unloaded (tab close)
        // e.persisted will be false for tab close, true for back/forward cache
        if (!e.persisted && !isNavigating && !isFormSubmitting && !isRefreshing) {
            sendTabCloseLogout();
        }
    });
    
    // Secondary detection for older browsers
    window.addEventListener('beforeunload', function(e) {
        // Only trigger if we're not navigating within the app
        if (!isNavigating && !isFormSubmitting && !isRefreshing) {
            // Don't show confirmation dialog, just send logout
            sendTabCloseLogout();
        }
    });
    
    // Handle browser tab visibility for extended absence
    let tabHiddenTime = 0;
    let tabVisibilityTimeout = null;
    
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'hidden') {
            tabHiddenTime = Date.now();
            
            // Set a timeout for extended tab hiding (30 minutes)
            tabVisibilityTimeout = setTimeout(function() {
                if (document.visibilityState === 'hidden') {
                    console.log('Tab hidden for 30 minutes - logging out');
                    window.location.href = '{{ url_for("logout") }}';
                }
            }, 30 * 60 * 1000); // 30 minutes
            
        } else if (document.visibilityState === 'visible') {
            // Clear the timeout when tab becomes visible again
            if (tabVisibilityTimeout) {
                clearTimeout(tabVisibilityTimeout);
                tabVisibilityTimeout = null;
            }
            
            // Check if tab was hidden for a very long time
            if (tabHiddenTime) {
                const timeHidden = Date.now() - tabHiddenTime;
                if (timeHidden > 60 * 60 * 1000) { // 1 hour
                    // Verify session is still valid after long absence
                    fetch('{{ url_for("check_session") }}', {
                        method: 'GET',
                        credentials: 'same-origin'
                    }).then(response => {
                        if (!response.ok) {
                            window.location.href = '{{ url_for("login") }}';
                        }
                    }).catch(() => {
                        // Network error - don't logout, might be temporary
                    });
                }
                tabHiddenTime = 0;
            }
        }
    });
    
    // Periodic session validation (every 10 minutes)
    setInterval(function() {
        // Only check if tab is visible to avoid unnecessary requests
        if (document.visibilityState === 'visible') {
            fetch('{{ url_for("check_session") }}', {
                method: 'GET',
                credentials: 'same-origin'
            }).then(response => {
                if (!response.ok || response.redirected) {
                    console.log('Session expired - redirecting to login');
                    window.location.href = '{{ url_for("login") }}';
                }
            }).catch(e => {
                // Network error - don't logout automatically
                console.log('Session check failed (network error):', e);
            });
        }
    }, 10 * 60 * 1000); // Check every 10 minutes
    
    // Handle page unload warning for unsaved changes (optional)
    window.addEventListener('beforeunload', function(e) {
        // You can add logic here to warn about unsaved changes
        // For now, we'll let the tab close normally
    });
    </script>
    {% endif %}
    
    {% block scripts %}{% endblock %}
</body>
</html>
