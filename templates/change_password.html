{% extends "base.html" %}

{% block title %}Change Password - Secret Journal Manager{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header text-center">
                <h4><i class="fas fa-lock me-2"></i>Change Password</h4>
                <p class="text-muted mb-0">Update your account password</p>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>Password Security</h6>
                    <p class="mb-0">Your new password will re-encrypt all your secrets. Choose a strong, unique password that you can remember.</p>
                </div>
                
                {% if current_user.is_admin %}
                <div class="alert alert-info">
                    <h6><i class="fas fa-shield-alt me-2"></i>Admin Password Change</h6>
                    <p class="mb-0"><strong>Good news!</strong> As an admin, changing your password no longer requires rotating the Admin Master Key by default. All users' admin-encrypted keys (A-DEKs) will continue to work normally.</p>
                    <p class="mt-2 mb-0"><small><strong>Note:</strong> The admin master key is now stored independently of admin passwords, ensuring users can rotate their keys without admin intervention.</small></p>
                </div>
                {% endif %}
                
                <form method="POST" id="changePasswordForm">
                    <div class="mb-3">
                        <label for="current_password" class="form-label">Current Password *</label>
                        <input type="password" class="form-control" id="current_password" name="current_password" required>
                        <div class="form-text">Enter your current password to verify identity</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="new_password" class="form-label">New Password *</label>
                        <input type="password" class="form-control" id="new_password" name="new_password" required minlength="8">
                        <div class="form-text">Choose a strong password with at least 8 characters</div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="confirm_password" class="form-label">Confirm New Password *</label>
                        <input type="password" class="form-control" id="confirm_password" name="confirm_password" required minlength="8">
                        <div class="form-text">Re-enter your new password</div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Important</h6>
                        <ul class="mb-0 small">
                            {% if current_user.is_admin %}
                            <li><strong>Admin Operation:</strong> This will rotate the system-wide Admin Master Key</li>
                            <li><strong>System Impact:</strong> All users' admin-encrypted keys (A-DEKs) will be updated</li>
                            <li><strong>Process Time:</strong> This may take several minutes depending on user count</li>
                            <li>Your recovery options (security questions, recovery phrase) will remain unchanged</li>
                            {% else %}
                            <li>Changing your password will re-encrypt all your secrets</li>
                            <li>Make sure you remember your new password</li>
                            <li>Your recovery options (security questions, recovery phrase) will remain unchanged</li>
                            <li>This process may take a moment to complete</li>
                            {% endif %}
                        </ul>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                            <i class="fas fa-save me-2"></i>Change Password
                        </button>
                        <a href="{{ url_for('user_profile') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Back to Profile
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-body bg-success text-white text-center">
                <h6><i class="fas fa-shield-alt me-2"></i>Password Tips</h6>
                <ul class="list-unstyled mb-0 small">
                    <li>✓ Use a mix of letters, numbers, and symbols</li>
                    <li>✓ Make it at least 12 characters long</li>
                    <li>✓ Don't use common words or personal information</li>
                    <li>✓ Consider using a password manager</li>
                    <li>✓ Don't reuse passwords from other accounts</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
    const currentPassword = document.getElementById('current_password').value;
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    const submitBtn = document.getElementById('submitBtn');
    
    // Basic validation
    if (!currentPassword || !newPassword || !confirmPassword) {
        e.preventDefault();
        alert('Please fill in all password fields!');
        return false;
    }
    
    if (newPassword !== confirmPassword) {
        e.preventDefault();
        alert('New passwords do not match!');
        return false;
    }
    
    if (newPassword.length < 8) {
        e.preventDefault();
        alert('New password must be at least 8 characters long!');
        return false;
    }
    
    if (currentPassword === newPassword) {
        e.preventDefault();
        alert('New password must be different from current password!');
        return false;
    }
    
    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Changing Password...';
    submitBtn.disabled = true;
});

// Real-time password strength indicator
document.getElementById('new_password').addEventListener('input', function() {
    const password = this.value;
    const strengthDiv = document.getElementById('password-strength') || createStrengthIndicator();
    
    const strength = calculatePasswordStrength(password);
    updateStrengthIndicator(strengthDiv, strength);
});

function createStrengthIndicator() {
    const div = document.createElement('div');
    div.id = 'password-strength';
    div.className = 'mt-2';
    document.getElementById('new_password').parentNode.appendChild(div);
    return div;
}

function calculatePasswordStrength(password) {
    let score = 0;
    let feedback = [];
    
    if (password.length >= 8) score += 1;
    else feedback.push('At least 8 characters');
    
    if (password.length >= 12) score += 1;
    else feedback.push('12+ characters recommended');
    
    if (/[a-z]/.test(password)) score += 1;
    else feedback.push('Include lowercase letters');
    
    if (/[A-Z]/.test(password)) score += 1;
    else feedback.push('Include uppercase letters');
    
    if (/\d/.test(password)) score += 1;
    else feedback.push('Include numbers');
    
    if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) score += 1;
    else feedback.push('Include special characters');
    
    const levels = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong', 'Very Strong'];
    return {
        score: score,
        level: levels[score] || 'Very Weak',
        feedback: feedback
    };
}

function updateStrengthIndicator(div, strength) {
    const colors = ['danger', 'danger', 'warning', 'info', 'success', 'success'];
    const color = colors[strength.score] || 'danger';
    
    div.innerHTML = `
        <div class="progress mb-1" style="height: 8px;">
            <div class="progress-bar bg-${color}" style="width: ${(strength.score / 6) * 100}%"></div>
        </div>
        <small class="text-${color}">Password Strength: ${strength.level}</small>
    `;
    
    if (strength.feedback.length > 0) {
        div.innerHTML += `<br><small class="text-muted">Suggestions: ${strength.feedback.join(', ')}</small>`;
    }
}
</script>
{% endblock %}
