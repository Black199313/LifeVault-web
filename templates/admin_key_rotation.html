{% extends "base.html" %}
{% set title = "Key Rotation Management" %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3><i class="fas fa-sync-alt"></i> Key Rotation Management</h3>
                    <button class="btn btn-primary" onclick="refreshRequests()">
                        <i class="fas fa-refresh"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <!-- Pending Requests Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4><i class="fas fa-clock"></i> Pending Rotation Requests</h4>
                                <div id="request_stats" class="text-muted">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                            <div id="pending_requests_container">
                                <div class="text-center">
                                    <i class="fas fa-spinner fa-spin"></i> Loading requests...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Actions Section -->
                    <div class="row">
                        <div class="col-12">
                            <h4><i class="fas fa-tools"></i> Admin Actions</h4>
                            <div class="card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h5>Finalize A-DEK</h5>
                                            <p>Replace temporary A-DEK with admin master key encrypted version.</p>
                                            <form id="finalizeForm">
                                                <div class="mb-3">
                                                    <label for="finalize_token_id" class="form-label">Token ID</label>
                                                    <input type="text" class="form-control" id="finalize_token_id" 
                                                           placeholder="Enter rotation token ID">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="temp_password_finalize" class="form-label">Temporary Password</label>
                                                    <input type="password" class="form-control" id="temp_password_finalize" 
                                                           placeholder="Temporary password used in rotation">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="admin_password_finalize" class="form-label">Your Admin Password</label>
                                                    <input type="password" class="form-control" id="admin_password_finalize" 
                                                           placeholder="Your admin password">
                                                </div>
                                                <button type="submit" class="btn btn-success">
                                                    <i class="fas fa-check"></i> Finalize A-DEK
                                                </button>
                                            </form>
                                        </div>
                                        <div class="col-md-6">
                                            <h5>System Status</h5>
                                            <div id="system_status">
                                                <div class="alert alert-info">
                                                    <i class="fas fa-info-circle"></i> System operational
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Dangerous Actions Section -->
                                    <hr class="my-4">
                                    <div class="row">
                                        <div class="col-12">
                                            <h5 class="text-danger">
                                                <i class="fas fa-exclamation-triangle"></i> Dangerous Actions
                                            </h5>
                                            <div class="alert alert-warning">
                                                <strong>Warning:</strong> These actions cannot be undone and will affect all users.
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card border-danger">
                                                <div class="card-body">
                                                    <h6 class="card-title text-danger">Delete All Rotation Requests</h6>
                                                    <p class="card-text">
                                                        This will permanently delete ALL rotation requests for ALL users, 
                                                        regardless of their status (pending, approved, completed, etc.).
                                                    </p>
                                                    <div class="mb-3">
                                                        <label for="admin_password_delete_all" class="form-label">Your Admin Password</label>
                                                        <input type="password" class="form-control" id="admin_password_delete_all" 
                                                               placeholder="Enter your admin password to confirm">
                                                    </div>
                                                    <button type="button" class="btn btn-danger" onclick="deleteAllRotationRequests()">
                                                        <i class="fas fa-trash-alt"></i> Delete All Requests
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Approval Modal -->
<div class="modal fade" id="approvalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Approve Key Rotation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="approval_details"></div>
                <div class="alert alert-warning">
                    <strong>Important:</strong> Approving this request will generate a temporary password. 
                    You must provide this password to the user and ensure they complete the rotation 
                    before it expires.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirm_approval">
                    <i class="fas fa-check"></i> Approve Rotation
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentTokenId = null;

// Load pending requests on page load
document.addEventListener('DOMContentLoaded', function() {
    refreshRequests();
    loadRequestStats();
});

async function loadRequestStats() {
    try {
        const response = await fetch('/admin/api/rotation_request_stats');
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('request_stats').innerHTML = `
                <small>
                    Total: ${data.total_requests} | 
                    Pending: ${data.pending} | 
                    Approved: ${data.approved} | 
                    Completed: ${data.completed} | 
                    Other: ${data.other}
                </small>
            `;
        }
    } catch (error) {
        console.error('Failed to load request stats:', error);
    }
}

async function refreshRequests() {
    try {
        const response = await fetch('/admin/api/rotation_requests');
        const data = await response.json();
        
        if (data.requests) {
            displayRequests(data.requests);
        } else {
            showError('Failed to load requests: ' + (data.error || 'Unknown error'));
        }
        
        // Also refresh stats
        loadRequestStats();
    } catch (error) {
        console.error('Failed to fetch requests:', error);
        showError('Failed to load requests. Please refresh the page.');
    }
}

function displayRequests(requests) {
    const container = document.getElementById('pending_requests_container');
    
    if (requests.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> No pending rotation requests.
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Reason</th>
                        <th>Requested</th>
                        <th>Expires</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    requests.forEach(request => {
        const requestedDate = new Date(request.requested_at).toLocaleString();
        const expiresDate = new Date(request.expires_at).toLocaleString();
        
        html += `
            <tr>
                <td>
                    <strong>${request.user_username}</strong><br>
                    <small class="text-muted">${request.user_email}</small>
                </td>
                <td>${request.reason || 'No reason provided'}</td>
                <td>${requestedDate}</td>
                <td>${expiresDate}</td>
                <td>
                    <button class="btn btn-success btn-sm" onclick="approveRequest('${request.token_id}', '${request.user_username}', '${request.reason}')">
                        <i class="fas fa-check"></i> Approve
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
}

function approveRequest(tokenId, username, reason) {
    currentTokenId = tokenId;
    
    document.getElementById('approval_details').innerHTML = `
        <p><strong>User:</strong> ${username}</p>
        <p><strong>Reason:</strong> ${reason || 'No reason provided'}</p>
        <p><strong>Token ID:</strong> ${tokenId}</p>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('approvalModal'));
    modal.show();
}

document.getElementById('confirm_approval').addEventListener('click', async function() {
    if (!currentTokenId) return;
    
    const button = this;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Approving...';
    
    try {
        const response = await fetch(`/admin/api/approve_rotation/${currentTokenId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Show temporary password to admin
            alert(`Rotation approved!\n\nTemporary Password: ${result.temporary_password}\n\nPlease provide this password to the user. It expires at: ${new Date(result.expires_at).toLocaleString()}`);
            
            // Close modal and refresh requests
            bootstrap.Modal.getInstance(document.getElementById('approvalModal')).hide();
            refreshRequests();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        console.error('Approval failed:', error);
        alert('Failed to approve request. Please try again.');
    } finally {
        button.disabled = false;
        button.innerHTML = originalText;
    }
});

document.getElementById('finalizeForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const tokenId = document.getElementById('finalize_token_id').value.trim();
    const tempPassword = document.getElementById('temp_password_finalize').value;
    const adminPassword = document.getElementById('admin_password_finalize').value;
    
    if (!tokenId || !tempPassword || !adminPassword) {
        alert('Please fill in all fields.');
        return;
    }
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Finalizing...';
    
    try {
        const response = await fetch(`/admin/api/finalize_a_dek/${tokenId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                temporary_password: tempPassword,
                admin_password: adminPassword
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('A-DEK finalized successfully!');
            // Clear form
            e.target.reset();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        console.error('Finalization failed:', error);
        alert('Failed to finalize A-DEK. Please try again.');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
});

function showError(message) {
    document.getElementById('pending_requests_container').innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> ${message}
        </div>
    `;
}

async function deleteAllRotationRequests() {
    const adminPassword = document.getElementById('admin_password_delete_all').value;
    
    if (!adminPassword) {
        alert('Please enter your admin password to confirm this action.');
        return;
    }
    
    // Get current stats to show in confirmation
    let statsText = '';
    try {
        const statsResponse = await fetch('/admin/api/rotation_request_stats');
        const statsData = await statsResponse.json();
        if (statsData.success && statsData.total_requests > 0) {
            statsText = `\nCurrent requests:\n- Total: ${statsData.total_requests}\n- Pending: ${statsData.pending}\n- Approved: ${statsData.approved}\n- Completed: ${statsData.completed}\n- Finalized: ${statsData.finalized}\n- Other: ${statsData.other}\n`;
        } else if (statsData.total_requests === 0) {
            alert('No rotation requests found to delete.');
            return;
        }
    } catch (error) {
        console.log('Could not load stats for confirmation');
    }
    
    // Double confirmation for this dangerous action
    const confirmMessage = `⚠️  DANGER: DELETE ALL ROTATION REQUESTS  ⚠️

This will permanently delete ALL rotation requests for ALL users, including:
- Pending requests
- Approved requests  
- Completed requests
- Failed requests
${statsText}
This action CANNOT BE UNDONE.

Are you absolutely sure you want to proceed?`;
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    // Second confirmation
    const secondConfirm = prompt(`Type "DELETE ALL REQUESTS" to confirm this destructive action:`);
    if (secondConfirm !== "DELETE ALL REQUESTS") {
        alert('Action cancelled. Exact text not entered.');
        return;
    }
    
    try {
        const response = await fetch('/admin/api/delete_all_rotation_requests', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                admin_password: adminPassword
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`Success: Deleted ${result.deleted_count} rotation requests.`);
            // Clear the password field and refresh requests
            document.getElementById('admin_password_delete_all').value = '';
            refreshRequests();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        console.error('Delete all requests failed:', error);
        alert('Failed to delete requests. Please try again.');
    }
}
</script>
{% endblock %}
